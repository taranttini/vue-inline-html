<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Vue Inline Html</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.21/vue.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>

</head>

<body>
  <div id="app"></div>

  <!-- https://www.gstatic.com/firebasejs/ui/3.5.1/firebase-ui-auth__pt.js -->

  <!-- this file have config for you firebase -->
  <script src="firebase-config.js"></script>
  
  <script>

    function addStorage() {
      try {
        var data = { events: store.state.events, users: store.state.users }
        window.localStorage.setItem('data', JSON.stringify(data))
      } catch (err) {
        util.error(err)
      }
    }

    function getStorage() {
      try {
        if (window.localStorage.hasOwnProperty('data')) {
          var data = JSON.parse(window.localStorage.data);
          if (!data) return;

          store.state.events = Object.assign({}, data.events);
          store.state.users = Object.assign({}, data.users);
          util.log('data loaded')
        }
      } catch (err) {
        util.error(err)
      }
    }

    var util = {
      guid() {
        return '_' + Math.random().toString(36).substr(2, 9);
      },
      log(...args) {
        console.log(...args)
      },
      error(...args) {
        console.error(...args)
      },
      isNull(obj) {
        //util.log('call isNull', obj)
        return obj === null || obj === undefined ? true : false;
      },
      isEmpty(obj) {
        //util.log('call isEmpty', obj)
        return util.isNull(obj) || obj.trim().length === 0 ? true : false;
      },
      isLessLength(obj, value) {
        //util.log('call isLessLength', obj, value)
        return util.isEmpty(obj) || obj.trim().length < value ? true : false;
      }
    }


    var store = {
      debug: true,
      state: {
        isProcessing: false,
        events: {},
        isLogged: false,
        eventKey: null,
        selectedEvent: null,
        users: {},
      }

      ,setProcessing(value) {
        util.log('call setProcessing', value);
        store.state.isProcessing = value;
      }

      ,event: {

        add(event) {

          util.log('call event.add', event);
          store.state.isProcessing = true;

          return new Promise((resolve, reject) => {

            store.state.isProcessing = false;

            if (util.isNull(event) || util.isEmpty(event.name)) {
              reject('Event name is necessary')
            }
            if (util.isLessLength(event.name, 3)) {
              reject('Event name needs have a minimum 3 characters.')
            }
            else if (store.state.events.hasOwnProperty(event.name)) {
              reject('This event already exists.')
            }
            else {
              var key = util.guid();
              store.state.events[key] = event;
              //update object
              store.state.events = Object.assign({}, store.state.events)

              addStorage();

              resolve('Event has been created');
            }
          })
        }

        ,update(event) {

          util.log('call event.update', event);

          var key = store.state.eventKey

          return new Promise((resolve, reject) => {

            if (util.isNull(event)) {
              reject('event not found')
              return
            }
            else if (util.isEmpty(event.name)) {
              reject('blank name is not valid.')
              return;
            }
            else {
              // update state.event[key] = event
              Vue.set(store.state.events, key, event)

              addStorage();

              resolve('this event has been updated.')
            }
          })
        },

        load() {

          util.log('call event.load');

          if (window.localStorage.hasOwnProperty('events')) {
            store.state.events = Object.assign({}, JSON.parse(window.localStorage.events));
          }
        },

        select(eventKey) {

          util.log('call event.select', eventKey);

          var event = store.state.events[eventKey];
          store.state.eventKey = eventKey;
          store.state.selectedEvent = event;
        },
      },

      user: {

        payEvent(userName) {

          if (this.debug) util.log('call user.payEvent');
          this.changeAttr(userName, 'pay')
        }

        ,joinEvent(userName) {

          if (this.debug) util.log('call user.joinEvent');
          this.changeAttr(userName, 'join')
        }

        ,changeAttr(userName, field) {

          util.log('call changeAttr', userName, field, store.state.selectedEvent);


          if (store.state.eventKey) {

            var event = store.state.selectedEvent;
            var users = event.users || {};
            var user = users[userName] || {};

            util.log(1, JSON.stringify({ e: event, u: user, us: users, s: store.state.events }));
            switch (field) {
              case 'join':
                user[field] = user[field] == 1 ? 0 : 1;
                break;
              case 'pay':
                user['join'] = user['join'] || 1;
                user[field] = user[field] == true ? false : true;
                break;
            }
            // update object users[userName] = user
            Vue.set(users, userName, user);

            util.log(2, JSON.stringify({ e: event, u: user, us: users, s: store.state.events }));
            // update object event[users] = users
            Vue.set(event, 'users', users)
            util.log(3, JSON.stringify({ e: event, u: user, us: users, s: store.state.events }));
            // update object
            store.state.events = Object.assign({}, store.state.events);
          }
        }

        ,add(user) {

          if (store.debug) util.log('call user.add', user);

          return new Promise((resolve, reject) => {
            if (
              user.name === undefined ||
              user.name.toString().trim().length === 0) {
              reject('blank name is not valid.')
              return;
            }
            var key = util.guid()
            store.state.users[key] = user;

            addStorage();

            resolve('this user has been added.')
          })
        }

        ,update(userKey, user) {

          if (store.debug) util.log('call user.update', userKey, user);

          var hasKey = store.state.users.hasOwnProperty(userKey)

          return new Promise((resolve, reject) => {
            if (!hasKey) {
              reject('user not found')
              return;
            }
            if (user.name === undefined ||
              user.name.toString().trim().length === 0) {
              reject('blank name is not valid.')
              return;
            }
            Vue.set(store.state.users, userKey, user)
            resolve('this user has been updated.')
          })

        }
      }

      ,login: {

        create(login) {
          console.log('login.create', login)
          return google.create(login);
        },

        connect(login) {
          console.log('login.connect', login)
          if (this.debug) util.log('call login.connect');

          return google.login(login);
          

          return new Promise((resolve, reject) => {
            console.log(login)
            if(login.email === "demo@demo.com" && login.pass === "demo") {
              resolve('loggin')
            } 
            else {
              reject('login invalid')
            }

          })
        }

      }

    }


    var google = {

        isLogged() {
          util.log('call google.isLogged', firebase.auth().currentUser ? true : false)
          return firebase.auth().currentUser ? true : false

        },

        create(account) {
          
          return new Promise((resolve, reject) => {

          firebase.auth().createUserWithEmailAndPassword(account.email, account.password)
            .then((e) => {
              resolve(e)
            })
            .catch((error) => {
              console.log('eee', error)
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;

              if(errorCode == 'auth/weak-password') {
                reject('A senha é muito fraca.')  
              }
              else {
                reject(errorMessage)
              }

              
              // ...
            });

          })
        },

        login(account) {

          return new Promise((resolve, reject) => {

            firebase.auth().signInWithEmailAndPassword(account.email, account.password)
              .then((e)=> {
                console.log(e)

                resolve(e)
              })
              .catch((error) => {
                console.log(error)
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;

                if (errorCode === 'auth/wrong-password') {
                  reject('Usuário ou senha errados.');
                } 
                else {
                  reject(errorMessage);
                }
                
                // ...
              });

          })
        },

        logoff() {
          util.log('call google.logoff')
          firebase.auth().signOut();
        },


    }

  </script>

  <script type="text/x-template" id="my-confirm">
        <div>
      <h2>{{msg}}</h2>
      <button @click.prevent="confirm">Confirm</button>
      <button @click.prevent="cancel">Cancel</button>
    </div>
  </script>
  <script>
    var MyConfirm = Vue.component('my-confirm', {
      props: {
        component: String,
        msg: {
          type: String,
          required: true
        }
      },
      methods: {
        confirm() { EventBus.$emit(this.component + 'Confirm'); },
        cancel() { EventBus.$emit(this.component + 'Cancel'); }
      },
      template: '#my-confirm'
    })
  </script>


  <script type="text/x-template" id="my-event-data">
        <div v-if="editData">
        <div v-if="isProcessing">processing...</div>
        <div v-if="showNew">
          <div>
            <h2>{{mode}} Event</h2>
              <div>
                <input type="text" v-model="event.name" placeholder="Event Name" @keyup.enter="addEvent" />
              </div>
              <div>
                <textarea v-model="event.description" placeholder="Event Description" @keyup.enter="addEvent" />
              </div>
            </div>
          <div>
            <button @click.prevent="addEvent">Save</button>
            <button @click.prevent="cancelEvent">Cancel</button>
          </div>
        </div>
        <my-confirm :component='component' :msg="msgConfirm" v-else></my-confirm>
        <p>{{errorMsg}}</p>
      </div>
  </script>
  <script>
    var MyEventData = Vue.component('my-event-data', {
      data() {
        return {
          component: 'newEvent',
          event: {},
          mode: '',
          errorMsg: '',
          showNew: true,
          editData: false,
          sharedEvents: store.state
        }
      },
      created() {
        EventBus.$on(this.component + 'Confirm', () => { this.confirmEvent() });
        EventBus.$on(this.component + 'Cancel', () => { this.cancelConfirm() });

        EventBus.$on('showEventEdit', () => {
          this.event = Object.assign({}, this.sharedEvents.selectedEvent)
          this.mode = 'Edit'
          this.errorMsg = ''
          this.showNew = true
          this.editData = true
        })

        EventBus.$on('showEventNew', () => {
          this.event = {}
          this.mode = 'New'
          this.errorMsg = ''
          this.showNew = true
          this.editData = true
        })

        EventBus.$on('hideEventData', () => {
          this.editData = false
        })
      },
      computed: {
        isProcessing() {
          return this.sharedEvents.isProcessing;
        },
        msgConfirm() {
          return `Confirm ${this.mode} event "${this.event.name || ''}"?`
        }
      },
      methods: {
        addEvent() {
          util.log('call addEvent');
          this.errorMsg = ''
          this.showNew = false;
        },
        confirmEvent() {
          util.log('call confirmEvent');

          var data = {};


          if (this.mode === 'Edit') {
            data = store.event.update(this.event)
          }
          else {
            data = store.event.add(this.event)
          }

          data.then((e) => {
            console.log('ok')
            this.gotoEventList();
          })
            .catch((e) => {
              console.log('not ok', e)
              this.errorMsg = e
              this.showNew = true
            })
        },
        clean() {
          this.event = {}
          this.errorMsg = ''
          this.showNew = false
        },
        gotoEventList() {
          util.log('call gotoEventList');
          this.clean();
          EventBus.$emit('showEventList');
        },
        cancelConfirm() {
          util.log('call cancelConfirm');
          this.showNew = true;
        },
        cancelEvent() {
          util.log('call cancelEvent');
          EventBus.$emit('showEventList')
          this.editData = false
        }
      },
      components: {
        MyConfirm
      },
      template: '#my-event-data'
    })
  </script>

  <script type="text/x-template" id="my-event-list">
        <div>
        <h2>List Events</h2>
        <ul>
          <li v-for="(event, key) in events" :key="key">
            <a href="#" @click.prevent="selectEvent(key)">{{isActive(key)}}{{event.name}}</a>
            <button @click.prevent="editEvent(key)">Edit</button>
          </li>
        </ul>
      </div>
  </script>
  <script>
    var MyEventList = Vue.component('my-event-list', {
      data() {
        return {
          sharedEvents: store.state
        }
      },
      computed: {
        events() {
          return this.sharedEvents.events
        }
      },
      methods: {

        selectEvent(eventKey) {
          util.log('call selectEvent', eventKey);
          store.event.select(eventKey)
          EventBus.$emit('showEventUsers')
        },
        editEvent(eventKey) {
          util.log('call editEvent', eventKey);
          store.event.select(eventKey)
          EventBus.$emit('showEventEdit')
        },
        isActive(eventKey) {
          return this.sharedEvents.eventKey == eventKey ? '> ' : '';
        }
      },
      template: '#my-event-list'
    });
  </script>

  <script type="text/x-template" id="my-selected-event">
        <div>
        <h2>Selected Event {{eventName}}</h2>
        <div v-if="selectedEvent">
            <my-confirm v-if="showConfirm" :component="component" :msg="msgConfirm"></my-confirm>
            <div v-for="(user, key) in users" :key="key">
                <span>{{user.name}}</span>
                  <button :disabled="showConfirm" v-if="isActive(key) == false" @click.prevent="join(key, user.name, $event)">Join</button>
                  <button :disabled="showConfirm" @click.prevent="pay(key, user.name, $event)">
                      <span v-if="isPaid(key) == false">Pay</span>
                      <span v-else>Mark as unpaid</span>
                  </button>
                </div>

            </div>
        </div>
    </div>
  </script>
  <script>
    var MySelectedEvent = Vue.component('my-selected-event', {
      data() {
        return {
          sharedEvents: store.state,
          component: 'selectedEvent',
          selectedName: null,
          showConfirm: false,
          selectedAction: null,
          msgConfirm: ''
        }
      },
      created() {
        EventBus.$on(this.component + 'Confirm', () => { this.confirmAction() });
        EventBus.$on(this.component + 'Cancel', () => { this.cancelAction() });
      },
      computed: {
        eventName() {
          return this.sharedEvents.selectedEvent.name
        },
        users() {
          return this.sharedEvents.users
        },
        selectedEvent() {
          return this.sharedEvents.selectedEvent
        },
      },
      methods: {
        isActive(userKey) {
          util.log('call isAtive', userKey);

          var users = this.selectedEvent.users;

          if (users &&
            users[userKey] &&
            users[userKey]['join'] &&
            users[userKey]['join'] === 1) return true;

          return false;
        },
        isPaid(userKey) {
          util.log('call isPaid', userKey)
          var users = this.selectedEvent.users;

          if (users &&
            users[userKey] &&
            users[userKey]['pay'] &&
            users[userKey]['pay'] === true) return true;

          return false;
        },
        selectEvent(eventKey) {
          util.log('call selectEvent', eventKey);
          store.selectEvent(eventKey)
        },
        callConfirmAction(actionName, key, userName, actionText) {
          this.msgConfirm = "Confirm " + actionText + " user " + userName + "?";
          this.selectedAction = actionName;
          this.selectedName = key;
          this.showConfirm = true;
        },
        join(key, userName, e) {
          util.log('call join', name);
          //store.user.joinEvent(userName)
          this.callConfirmAction('join', key, userName, e.target.innerText);
        },
        pay(key, userName, e) {
          util.log('call pay', userName);
          store.user.payEvent(userName);
          this.callConfirmAction('pay', key, userName, e.target.innerText);
        },
        confirmAction() {
          switch (this.selectedAction) {
            case 'pay':
              store.user.payEvent(this.selectedName);
              break;
            case 'join':
              store.user.joinEvent(this.selectedName);
              break;
          }
          this.showConfirm = false;
        },
        cancelAction() {
          util.log('call cancel')
          this.showConfirm = false;
        }
      },
      components: {
        MyConfirm
      },
      template: '#my-selected-event'
    })
  </script>


  <script type="text/x-template" id="my-user-list">
        <div>
      <h2>User List</h2>
      <ul>
        <li v-for="(user, key) in users">
          <span>{{ user.name }}</span><button @click.prevent="edit(key, user)">Edit</button>
        </li>
      </ul>
    </div>
  </script>
  <script>
    var MyUserList = Vue.component('my-user-list', {
      data() {
        return {
          sharedEvents: store.state
        }
      },
      computed: {
        users() {
          return this.sharedEvents.users;
        }
      },
      methods: {
        edit(key, user) {
          var userEdit = {
            key: key,
            data: user
          }
          EventBus.$emit('showUserEdit', userEdit)
        },
      },
      template: '#my-user-list'
    })
  </script>


  <script type="text/x-template" id="my-user-data">
        <div v-if="editData">
      <h2>{{mode}} User</h2>
      <div>
        <label>Name</label>
        <input type="text" v-model="user.name"  @keyup.enter="save" />
      </div>
      <div>
          <label>Email</label>
          <input type="email" v-model="user.email" @keyup.enter="save" />
      </div>
      <div>
        <button @click.prevent="save">Save</button>
        <button @click.prevent="cancel">Cancel</button>
      </div>
      <p>{{msg}}</p>
    </div>
  </script>
  <script>
    var MyUserData = Vue.component('my-user-data', {
      data() {
        return {
          user: {},
          userKey: '',
          mode: '',
          msg: '',
          editData: false
        }
      },
      mounted() {
        EventBus.$on('hideUserData', () => {
          this.editData = false
        })

        EventBus.$on('showUserEdit', user => {
          this.user = Object.assign({}, user.data)
          this.userName = user.key;
          this.mode = 'Edit'
          this.msg = ''
          this.editData = true
        });

        EventBus.$on('showUserNew', (user) => {
          this.user = {}
          this.mode = 'New'
          this.msg = ''
          this.editData = true
        })
      },
      methods: {
        save() {
          util.log('call save')
          var data = {};

          if (this.mode === 'Edit') {
            data = store.user.update(this.userName, this.user)
          } else {
            data = store.user.add(this.user)
          }
          data.then((e) => {
            this.goToUserList()
          })
          data.catch((e) => {
            this.msg = e
          })
        },
        cancel() {
          util.log('call cancel')
          this.goToUserList();
        },
        goToUserList() {
          util.log('call goToUserList')
          this.editData = false;
          EventBus.$emit('showUserList');
        }
      },
      template: '#my-user-data'
    })
  </script>


  <script type="text/x-template" id="my-login">
    <div>
      <pre>
        email: demo@demo.com
        password: demo
      </pre>
      <div>
        <div><input type="email" v-model="login.email" placeholder="Email" @keyup.enter="connect" /></div>
        <div><input type="password" v-model="login.password" placeholder="Password" @keyup.enter="connect" /></div>
      </div>
      <div>
        <button @click.prevent="connect">Login</button>
        <button @click.prevent="create">Create</button>
      </div>
      <p>{{msg}}</p>
    </div>
  </script>
  <script>
    var MyLogin = Vue.component('my-login',{
      data() {
        return {
          login: {},
          msg: ''
        }
      },

      methods: {

        create() {
          store.login.create(this.login)

          
          .then((e)=> {
              this.msg = e
              //EventBus.$emit('login')
            })

            .catch((e) => {
              this.msg = e
            })
            
        },

        connect() {
          store.login.connect(this.login)
            
            .then((e)=> {
              this.msg = e
              EventBus.$emit('login')
            })

            .catch((e) => {
              this.msg = e
            })
        },



      },
      template: '#my-login'
    })
  </script>



  <script type="text/x-template" id="my-event">
    <div>
        <my-login v-if="!connected"></my-login>
        <div v-else>
          <button @click.prevent="logoff">Logoff</button>
          <h3>Menu</h3>
          <ul>
            <li>Event</li>
            <li><button @click.prevent="selectEventList">Event List</button></li>
            <li><button @click.prevent="selectEventNew">New Event</button></li>
            <li>User</li>
            <li><button @click.prevent="selectUserList">User List</button></li>
            <li><button @click.prevent="selectUserNew">New User</button></li>
          </ul>
          <h3>Screen</h3>
          <div>
            <my-event-list v-if="showEventList" />
            <my-event-data />
            <my-selected-event v-if="showEventUsers"/>
            <my-user-list v-if=showUserList />
            <my-user-data />
          </div>

          <div>
              <h3>Code</h3>
              <pre>{{sharedEvents}}</pre>
          </div>
      </div>
    </div>
  </script>

  <script>
    var EventBus = new Vue();

    var MyEvent = Vue.component('my-event', {
      data() {
        return {
          connected: false,
          sharedEvents: store.state,
          showEventList: true,
          showEventNew: false,
          showEventData: false,
          showEventUsers: false,

          showUserList: false,
          showUserData: false
        }
      },
      created() {
        getStorage();

        EventBus.$on('login', ()=> { 
          console.log('logou')
          this.connected = true; 
          })

        EventBus.$on('showEventList', this.selectEventList)

        EventBus.$on('showEventUsers', () => { this.selectEventUsers() });

        EventBus.$on('showUserList', () => { this.selectUserList() });

        EventBus.$on('showEventEdit', () => { this.hideComponents() })

        EventBus.$on('showUserEdit', () => {
          this.hideComponents()
        })

        

        setTimeout(this.checkLogin(), 1000)
        
      },
      methods: {
        checkLogin() {

          this.connected = google.isLogged();

          console.log('checkLogin', new Date(), this.connected)

          if ( this.connected == false) {
            setTimeout(this.checkLogin, 1000)
          } 
          
        },
        logoff() {
          this.connected = false
          google.logoff()
        },

        selectEventUsers() {
          this.hideComponents()
          this.showEventUsers = true;
        },

        selectEventNew() {
          this.hideComponents()
          EventBus.$emit('showEventNew')
        },

        selectEventList() {
          this.hideComponents()
          this.showEventList = true
        },
        selectUserList() {
          this.hideComponents()
          this.showUserList = true
        },
        selectUserNew() {
          this.hideComponents()
          EventBus.$emit('showUserNew')
        },
        hideComponents() {
          this.showEventList = false
          this.showEventNew = false
          this.showUserList = false
          this.showEventUsers = false
          EventBus.$emit('hideUserData')
          EventBus.$emit('hideEventData')
          //this.showUserData = false
        }
      },
      components: {
        MyEventList,
        MyEventData,
        MySelectedEvent,

        MyUserList,
        MyUserData,

      },
      template: '#my-event',
    })



    new Vue({
      el: '#app',
      render: h => h(MyEvent),
      components: {
        MyEvent
      },
    });
 
    
    
  </script>



</body>

</html>