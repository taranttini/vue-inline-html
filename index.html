<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Vue Inline Html</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.21/vue.min.js"></script>
</head>

<body>
  <div id="app">
    <my-event msg='Study Code using Vue on simple file of HTML' />
  </div>

  <script>

    function addStorage(data) {
      try {
        window.localStorage.setItem('events', JSON.stringify(data))
      } catch (err) {
        console.error(err)
      }
    }
    function getStorage() {
      try {
        if (window.localStorage.hasOwnProperty('events')) {
          store.state.events = Object.assign({}, JSON.parse(window.localStorage.events));
          console.log('data loaded')
        }
      } catch (err) {
        console.error(err)
      }
    }

    var store = {
      debug: true,
      state: {
        isProcessing: false,
        events: { Event1: {} },
        eventName: null,
        selectedEvent: null,
        users: {},
      },
      setProcessing(value) {
        if (this.debug) console.log('call setProcessing');
        this.state.isProcessing = value;
      },
      addEvent(eventName) {
        if (this.debug) console.log('call addEvent');
        this.state.isProcessing = true;

        return new Promise((resolve, reject) => {

          this.state.isProcessing = false;

          if (eventName.length < 3) {
            reject('Event name needs have a minimum 3 characters.')

          } else if (this.state.events.hasOwnProperty(eventName)) {
            reject('This event already exists.')
          } else {
            this.state.events[eventName] = this.state.events[eventName] || {};
            //update object
            this.state.events = Object.assign({}, this.state.events)

            addStorage(this.state.events);

            resolve('Event has been created');
          }
        })
      },
      loadEvents() {
        if (window.localStorage.hasOwnProperty('events')) {
          this.state.events = Object.assign({}, JSON.parse(window.localStorage.events));
        }

      },
      selectEvent(eventName) {
        if (this.debug) console.log('call selectEvent');

        this.state.eventName = eventName;
        this.state.selectedEvent = this.state.events[eventName];
      },
      userPayEvent(userName) {
        if (this.debug) console.log('call userPayEvent');
        this.changeAttr(userName, 'pay')
      },
      userJoinEvent(userName) {
        if (this.debug) console.log('call userJoinEvent');
        this.changeAttr(userName, 'join')
      },
      changeAttr(userName, field) {
        console.log('call changeAttr', userName, field, this.state.selectedEvent);


        if (this.state.eventName) {

          var event = this.state.selectedEvent;
          var user = event[userName] || {};
          console.log(1, JSON.stringify(event), JSON.stringify(this.state.events));
          switch (field) {
            case 'join':
              user[field] = user[field] == 1 ? 0 : 1;
              break;
            case 'pay':
              user['join'] = user['join'] || 1;
              user[field] = user[field] == true ? false : true;
              break;
          }
          // update object
          Vue.set(event, userName, user);
          console.log(2, JSON.stringify(event), JSON.stringify(this.state.events));
          // update object
          this.state.events = Object.assign({}, this.state.events);
          //EventBus.$emit('updateEvents', this.this.state.events)
        }
      },
      addUser(user) {
        if (this.debug) console.log('call addEvent');

        return new Promise((resolve, reject) => {
          if (
            user.name === undefined ||
            user.name.toString().trim().length === 0) {
            reject('blank name is not valid.')
            return;
          }
          /*if (this.state.users.findIndex(u => u.name == user.name) != -1) {
            reject('this user already exists.')
            return;
          }*/
          var key = '_' + Math.random().toString(36).substr(2, 9);
          this.state.users[key] = user;
          resolve('this user has been added.')
        })
      },
      updateUser(userKey, user) {
        var hasKey = this.state.users.hasOwnProperty(userKey)

        return new Promise((resolve, reject) => {
          if (!hasKey) {
            reject('user not found')
            return;
          }
          if (user.name === undefined ||
            user.name.toString().trim().length === 0) {
            reject('blank name is not valid.')
            return;
          }
          Vue.set(this.state.users, userKey, user)
          resolve('this user has been updated.')
        })

      }

    }
  </script>

  <script type="text/x-template" id="my-confirm">
    <div>
      <h2>{{msg}}</h2>
      <button @click.prevent="confirm">Confirm</button>
      <button @click.prevent="cancel">Cancel</button>
    </div>
  </script>
  <script>
    var MyConfirm = Vue.component('my-confirm', {
      props: {
        component: String,
        msg: {
          type: String,
          required: true
        }
      },
      methods: {
        confirm() { EventBus.$emit(this.component + 'Confirm'); },
        cancel() { EventBus.$emit(this.component + 'Cancel'); }
      },
      template: '#my-confirm'
    })
  </script>


  <script type="text/x-template" id="my-new-event">
    <div>
      <div>
        <div v-if="isProcessing">processing...</div>
        <div v-if="showNew">
          <h2>Create new Event</h2>
          <input type="text" v-model="eventName" placeholder="Event Name" @keyup.enter="addEvent" />
          <button @click.prevent="addEvent">Add Event</button>
        </div>
        <my-confirm :component='component' :msg="msgConfirm" v-else></my-confirm>
        <p>{{errorMsg}}</p>
      </div>
    </div>
  </script>
  <script>

    var MyNewEvent = Vue.component('my-new-event', {
      data() {
        return {
          component: 'newEvent',
          eventName: '',
          errorMsg: '',
          showNew: true,
          sharedEvents: store.state
        }
      },
      created() {
        EventBus.$on(this.component + 'Confirm', () => { this.confirmEvent() });
        EventBus.$on(this.component + 'Cancel', () => { this.cancelEvent() });
      },
      mounted() {
        EventBus.$on('loadedEvents', (events) => {
          this.events = events;
          //this.events = Object.assign({}, events);
        })
      },
      computed: {
        isProcessing() {
          return this.sharedEvents.isProcessing;
        },
        msgConfirm() {
          return `Confirm new event "${this.eventName}"?`
        }
      },
      methods: {
        addEvent() {
          console.log('call addEvent');
          this.errorMsg = ''
          this.showNew = false;
        },
        confirmEvent() {
          console.log('call confirmEvent');

          this.eventName = this.eventName.trim();

          store.addEvent(this.eventName)
            .then((e) => {
              this.eventName = ''
              this.errorMsg = e
              this.showNew = true
            })
            .catch((e) => {
              this.errorMsg = e
              this.showNew = true
            })
        },
        cancelEvent() {
          console.log('call cancelEvent');
          this.showNew = true;
        }
      },
      components: {
        MyConfirm
      },
      template: '#my-new-event'
    })
  </script>

  <script type="text/x-template" id="my-event-list">
    <div>
        <h2>List Events</h2>
        <div v-for="(event,i) in Object.keys(events)" :key="i">
          <button @click.prevent="selectEvent(event)">{{event}} {{isActive(event)}}</button>
        </div>
      </div>
  </script>
  <script>
    var MyEventList = Vue.component('my-event-list', {
      data() {
        return {
          sharedEvents: store.state
        }
      },
      computed: {
        events() {
          return this.sharedEvents.events
        }
      },
      methods: {
        selectEvent(eventName) {
          console.log('call selectEvent', eventName);
          //this.selectedEventName = eventName;
          store.selectEvent(eventName)
          EventBus.$emit('showEventUsers')
        },
        isActive(eventName) {
          return this.sharedEvents.eventName == eventName ? 'active' : '';
        }
      },
      template: '#my-event-list'
    });
  </script>

  <script type="text/x-template" id="my-selected-event">
    <div>
        <h2>Selected Event {{eventName}}</h2>
        <div v-if="selectedEvent">
            <my-confirm v-if="showConfirm" :component="component" :msg="msgConfirm"></my-confirm>
            <div v-for="(user, key) in users" :key="key">
                <span>{{user.name}}</span>
                  <button :disabled="showConfirm" v-if="isActive(key) == false" @click.prevent="join(key, user.name, $event)">Join</button>
                  <button :disabled="showConfirm" @click.prevent="pay(key, user.name, $event)">
                      <span v-if="isPaid(key) == false">Pay</span>
                      <span v-else>Mark as unpaid</span>
                  </button>
                </div>

            </div>
        </div>
    </div>
  </script>
  <script>
    var MySelectedEvent = Vue.component('my-selected-event', {
      data() {
        return {
          sharedEvents: store.state,
          component: 'selectedEvent',
          selectedName: null,
          showConfirm: false,
          selectedAction: null,
          msgConfirm: ''
        }
      },
      created() {
        EventBus.$on(this.component + 'Confirm', () => { this.confirmAction() });
        EventBus.$on(this.component + 'Cancel', () => { this.cancelAction() });
      },
      computed: {
        eventName() {
          return this.sharedEvents.eventName
        },
        users() {
          return this.sharedEvents.users
        },
        selectedEvent() {
          return this.sharedEvents.selectedEvent
        },
      },
      methods: {
        isActive(userKey) {
          console.log('call isAtive', userKey);

          var event = this.selectedEvent;

          if (event &&
            event[userKey] &&
            event[userKey]['join'] &&
            event[userKey]['join'] === 1) return true;

          return false;
        },
        isPaid(userKey) {
          console.log('call isPaid', userKey)
          var event = this.selectedEvent;

          if (event &&
            event[userKey] &&
            event[userKey]['pay'] &&
            event[userKey]['pay'] === true) return true;

          return false;
        },
        selectEvent(eventName) {
          console.log('call selectEvent', eventName);
          store.selectEvent(eventName)
        },
        callConfirmAction(actionName, key, userName, actionText) {
          this.msgConfirm = "Confirm " + actionText + " user " + userName + "?";
          this.selectedAction = actionName;
          this.selectedName = key;
          this.showConfirm = true;
        },
        join(key, userName, e) {
          console.log('call join', name);
          //store.userJoinEvent(userName)
          this.callConfirmAction('join', key, userName, e.target.innerText);
        },
        pay(key, userName, e) {
          console.log('call pay', userName);
          //store.userPayEvent(userName);
          this.callConfirmAction('pay', key, userName, e.target.innerText);
        },
        confirmAction() {
          switch (this.selectedAction) {
            case 'pay':
              store.userPayEvent(this.selectedName);
              break;
            case 'join':
              store.userJoinEvent(this.selectedName);
              break;
          }
          this.showConfirm = false;
        },
        cancelAction() {
          console.log('call cancel')
          this.showConfirm = false;
        }
      },
      components: {
        MyConfirm
      },
      template: '#my-selected-event'
    })
  </script>


  <script type="text/x-template" id="my-user-list">
    <div>
      <h2>User List</h2>
      <ul>
        <li v-for="(user, key) in users">
          <span>{{ user.name }}</span><button @click.prevent="edit(key, user)">Edit</button>
        </li>
      </ul>
    </div>
  </script>
  <script>
    var MyUserList = Vue.component('my-user-list', {
      data() {
        return {
          sharedEvents: store.state
        }
      },
      computed: {
        users() {
          return this.sharedEvents.users;
        }
      },
      methods: {
        edit(key, user) {
          var userEdit = {
            key: key,
            data: user
          }
          EventBus.$emit('showUserEdit', userEdit)
        },
      },
      template: '#my-user-list'
    })
  </script>


  <script type="text/x-template" id="my-user-data">
    <div v-if="editData">
      <h2>{{mode}} User</h2>
      <div>
        <label>Name</label>
        <input type="text" v-model="user.name"  @keyup.enter="save" />
      </div>
      <div>
          <label>Email</label>
          <input type="email" v-model="user.email" @keyup.enter="save" />
      </div>
      <div>
        <button @click.prevent="save">Save</button>
        <button @click.prevent="cancel">Cancel</button>
      </div>
      <p>{{msg}}</p>
    </div>
  </script>
  <script>
    var MyUserData = Vue.component('my-user-data', {
      data() {
        return {
          user: {},
          userKey: '',
          mode: '',
          msg: '',
          editData: false
        }
      },
      mounted() {
        EventBus.$on('hideUser', () =>{
          this.editData = false
        })

        EventBus.$on('showUserEdit', user => {
          this.user = Object.assign({}, user.data)
          this.userName = user.key;
          this.mode = 'Edit'
          this.msg = ''
          this.editData = true
        });

        EventBus.$on('showUserNew', (user) => {
          this.user = {}
          this.mode = 'New'
          this.msg = ''
          this.editData = true
        })
      },
      methods: {
        save() {
          console.log('call save')
          var data = {};

          if (this.mode === 'Edit') {
            data = store.updateUser(this.userName, this.user)
          } else {
            data = store.addUser(this.user)
          }
          data.then((e) => {
            this.goToUserList()
          })
          data.catch((e) => {
            this.msg = e
          })
        },
        cancel() {
          console.log('call cancel')
          this.goToUserList();
        },
        goToUserList() {
          console.log('call goToUserList')
          this.editData = false;
          EventBus.$emit('showUserList');
        }
      },
      template: '#my-user-data'
    })
  </script>

  <script type="text/x-template" id="my-event">
      <div>
          <h3>Menu</h3>
          <ul>
            <li>Event</li>
            <li><button @click.prevent="selectEventList">Event List</button></li>
            <li><button @click.prevent="selectNewEvent">New Event</button></li>
            <li>User</li>
            <li><button @click.prevent="selectUserList">User List</button></li>
            <li><button @click.prevent="selectNewUser">New User</button></li>
          </ul>
          <h3>Screen</h3>
          <div>
            <my-new-event v-if="showNewEvent" />
            <my-event-list v-if="showEventList" />
            <my-selected-event v-if="showEventUsers"/>
            <my-user-list v-if=showUserList />
            <my-user-data />
          </div>

          <div>
              <h3>Code</h3>
              <pre>{{sharedEvents}}</pre>
          </div>
      </div>
  </script>

  <script>


    var EventBus = new Vue();

    var MyEvent = Vue.component('my-event', {
      data() {
        return {
          sharedEvents: store.state,
          showEventList: true,
          showNewEvent: false,
          showEventUsers: false,

          showUserList: false,
          showUserData: false
        }
      },
      created() {
        getStorage();

        EventBus.$on('showEventUsers', () => {
          this.hideComponents()
          this.showEventUsers = true
        });

        EventBus.$on('showUserList', () => {
          this.selectUserList()
        });

        EventBus.$on('showUserEdit', () => {
          this.hideComponents()
        })

      },
      methods: {
        selectNewEvent() {
          this.hideComponents()
          this.showNewEvent = true
        },
        selectEventList() {
          this.hideComponents()
          this.showEventList = true
        },
        selectUserList() {
          this.hideComponents()
          this.showUserList = true
        },
        selectNewUser() {
          this.hideComponents()
          EventBus.$emit('showUserNew')
          //this.showUserData = true
        },
        hideComponents() {
          this.showEventList = false
          this.showNewEvent = false
          this.showEventUsers = false
          this.showUserList = false
          EventBus.$emit('hideUser')
          //this.showUserData = false
        }
      },
      components: {
        MyEventList,
        MyNewEvent,
        MySelectedEvent,

        MyUserList,
        MyUserData,

      },
      template: '#my-event',
    })



    new Vue({
      el: "#app",
      components: {
        MyEvent
      },
    });
  </script>



</body>

</html>
